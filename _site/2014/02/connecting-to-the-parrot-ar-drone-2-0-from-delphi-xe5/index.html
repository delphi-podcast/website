<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=8dce9d32f790087ba98d18ab087bc3f67f3d9fc2">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Connecting to the Parrot AR.Drone 2.0 from Delphi XE5 | The Podcast at Delphi.org</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Connecting to the Parrot AR.Drone 2.0 from Delphi XE5" />
<meta name="author" content="Jim McKeeth" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My first thought when I see cool technology is to figure out how to connect to it with Delphi. So the day I got the Parrot AR.Drone 2.0 quadricopter I started working on Delphi interface. By the time evening rolled around the batteries were dead (after a couple recharges), but I had a basic interface working. The official developer guide seemed to be a little out of date, or I was reading it wrong, but once I got my facts staight, connecting was really easy. http://www.youtube.com/watch?v=aaGe2aERwgI The Parrot AR.Drone has it’s own access point. Once you’ve connected to it, then it is simply a matter of sending UDP packets for the basic controls. To accomplish that I simply used the Indy UDP Client: TIdUDPClient. Each command is sent with an increasing sequence number, so I initialize my interface as follows:" />
<meta property="og:description" content="My first thought when I see cool technology is to figure out how to connect to it with Delphi. So the day I got the Parrot AR.Drone 2.0 quadricopter I started working on Delphi interface. By the time evening rolled around the batteries were dead (after a couple recharges), but I had a basic interface working. The official developer guide seemed to be a little out of date, or I was reading it wrong, but once I got my facts staight, connecting was really easy. http://www.youtube.com/watch?v=aaGe2aERwgI The Parrot AR.Drone has it’s own access point. Once you’ve connected to it, then it is simply a matter of sending UDP packets for the basic controls. To accomplish that I simply used the Indy UDP Client: TIdUDPClient. Each command is sent with an increasing sequence number, so I initialize my interface as follows:" />
<link rel="canonical" href="http://localhost:4000/2014/02/connecting-to-the-parrot-ar-drone-2-0-from-delphi-xe5/" />
<meta property="og:url" content="http://localhost:4000/2014/02/connecting-to-the-parrot-ar-drone-2-0-from-delphi-xe5/" />
<meta property="og:site_name" content="The Podcast at Delphi.org" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-02-01T22:36:56-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Connecting to the Parrot AR.Drone 2.0 from Delphi XE5" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jim McKeeth"},"dateModified":"2014-02-01T22:36:56-07:00","datePublished":"2014-02-01T22:36:56-07:00","description":"My first thought when I see cool technology is to figure out how to connect to it with Delphi. So the day I got the Parrot AR.Drone 2.0 quadricopter I started working on Delphi interface. By the time evening rolled around the batteries were dead (after a couple recharges), but I had a basic interface working. The official developer guide seemed to be a little out of date, or I was reading it wrong, but once I got my facts staight, connecting was really easy. http://www.youtube.com/watch?v=aaGe2aERwgI The Parrot AR.Drone has it’s own access point. Once you’ve connected to it, then it is simply a matter of sending UDP packets for the basic controls. To accomplish that I simply used the Indy UDP Client: TIdUDPClient. Each command is sent with an increasing sequence number, so I initialize my interface as follows:","headline":"Connecting to the Parrot AR.Drone 2.0 from Delphi XE5","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2014/02/connecting-to-the-parrot-ar-drone-2-0-from-delphi-xe5/"},"url":"http://localhost:4000/2014/02/connecting-to-the-parrot-ar-drone-2-0-from-delphi-xe5/"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>delphiorg.github.io</h1>
        </a>
        <h2>The Podcast about the Delphi programming language, tools, news and community.</h2>

        <section id="downloads">
          
          <a href="https://github.com/delphiorg/delphiorg.github.io" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <small>1 February 2014</small>
<h1>Connecting to the Parrot AR.Drone 2.0 from Delphi XE5</h1>

<p class="view">by Jim McKeeth</p>

<p>My first thought when I see cool technology is to figure out how to connect to it with Delphi. So the day I got the Parrot AR.Drone 2.0 quadricopter I started working on Delphi interface. By the time evening rolled around the batteries were dead (after a couple recharges), but I had a basic interface working. The <a href="https://projects.ardrone.org/">official developer</a> guide seemed to be a little out of date, or I was reading it wrong, but once I got my facts staight, connecting was really easy. http://www.youtube.com/watch?v=aaGe2aERwgI The Parrot AR.Drone has it’s own access point. Once you’ve connected to it, then it is simply a matter of sending UDP packets for the basic controls. To accomplish that I simply used the Indy UDP Client: <strong>TIdUDPClient</strong>. Each command is sent with an increasing sequence number, so I initialize my interface as follows:</p>

<p>[delphi light=”true”]
  udp := TIdUDPClient.Create(nil);
  udp.Host := ‘192.168.1.1’;
  udp.Port := 5556;
  seq := 1;
[/delphi]</p>

<p>The AR.Drone is always at 192.168.1.1 since it is the access point, and the port for communication is 5556 (one of a few ports, but the one we need for now.) It is worth pointing out that if you’ve previously flown your AR.Drone with the FreeFlight mobile app then you may need to reset your drone to unpair it. Otherwise it is paired to only that device. The commands are formatted with an <strong>AT*</strong> prefix, and a series of arguments. For example, to take off, the command is <strong>AT*REF=1,290718208</strong> where <strong>AT*REF</strong> is the command, <strong>1</strong> is the sequence number (always the first argument) and <strong>290718208</strong> is a bitmask that means take off. I created a SendCommand routine that looks like:</p>

<p>[delphi light=”true”]
procedure TARDrone.SendCommand(cmd, arg: string);
var
  full: string;
begin
  if not udp.Active then Connect;</p>

<p>full := Format(‘%s=%d,%s’ + Chr(13), [Cmd, Seq, arg]);
  Seq := Seq + 1;
  udp.Send(full);
end;
[/delphi]</p>

<p>Notice the command is terminated with a carriage return (#13). The documentation says line-feed (#10), it is wrong. Supposedly you can send multiple commands in the same message, if they are separated by the carriage return. I haven’t tested that. Then I can send the some common commands like this:</p>

<p>[delphi light=”true”]
  SendCommand(‘AT<em>REF’,’290718208’); // Takeoff
  SendCommand(‘AT</em>REF’,’290717696’); // Land
  SendCommand(‘AT<em>CONFIG’, ‘"control:altitude_max","10000"’); // unlimited altitude
  SendCommand(‘AT</em>CONFIG’, ‘"control:altitude_max","5000"’); // restrituded altitude - unsure what units 500-5000.
  SendCommand(‘AT*PCMD’,’1,0,0,0,0’); // Hover (stop movement)
[/delphi]</p>

<p><strong>PCMD</strong> is the move command. It takes 5 arguments (after the sequence number.) The first is the controller type, which we are leaving <strong>1</strong> for now. The next 4 are <strong>phi, theta, gaz, yaw</strong> and they are floating point numbers in an integer representation. This is where it gets interesting. The documentation says:</p>
<blockquote>The number -<em>0.8</em> is stored in memory as a 32-bit word whose value is <em>BF4CCCCD(base 16)</em>, according to the IEEE-754 format. This 32-bit word can be considered as holding the 32-bit integer value -<em>1085485875(base 10)</em>.</blockquote>
<p>The first way I thought of to access the same memory as two different types is a variant record. So I came up with the following helper routine:</p>

<p>[delphi light=”true”]
function IEEEFloat(const aFloat: Single): Integer;
type
  TIEEEFloat = record
    case Boolean of
      True: (Float: Single);
      False: (Int: Integer);
  end;
var
  Convert: TIEEEFloat;
begin
  Convert.Float := aFloat;
  Result := Convert.Int;
end;
[/delphi]</p>

<p>Using that I built a move routine that takes 4 singles (32-bit floats) and sends them as integers:</p>

<p>[delphi light=”true”]
procedure TARDrone.Move(const phi, theta, gaz, yaw: Single);
begin
  SendCommand(‘AT*PCMD’,Format(‘1,%d,%d,%d,%d’,
    [IEEEFloat(phi), IEEEFloat(theta), IEEEFloat(gaz), IEEEFloat(yaw)]));
end;
[/delphi]</p>

<p>Now if I want the drone to go up I can call:</p>

<p>[delphi light=”true”]
  Move(0,0,5.6,0); // positive gaz is upward acceleration
[/delphi]</p>

<p>Now it is just a matter of figuring out how to the rest of the movements map to the physical worked and building a user interface on Android, iOS, Windows or Mac. Maybe all 4! Once I build up the API a little bit more I’ll share some full working apps and libraries. Let me know if you are interested in collaborating on such.</p>



  <small>tags: <em>api</em> - <em>Brain Computer Interface</em> - <em>delphi</em> - <em>devices</em> - <em>gadgets</em> - <em>iOS</em> - <em>Mobile</em> - <em>parrot</em> - <em>quadricopter</em> - <em>xe5</em></small>


      </section>
    </div>
  </body>
</html>
