<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=8dce9d32f790087ba98d18ab087bc3f67f3d9fc2">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Decompressing the TRESTResponse | The Podcast at Delphi.org</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Decompressing the TRESTResponse" />
<meta name="author" content="Jim McKeeth" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="RAD Studio, Delphi and C++ 10 Seattle has a fantastic REST Client Library. If you are unfamiliar with it, check out my 5 Minute REST Client video." />
<meta property="og:description" content="RAD Studio, Delphi and C++ 10 Seattle has a fantastic REST Client Library. If you are unfamiliar with it, check out my 5 Minute REST Client video." />
<link rel="canonical" href="http://localhost:4000/2016/01/decompressing-the-trestresponse/" />
<meta property="og:url" content="http://localhost:4000/2016/01/decompressing-the-trestresponse/" />
<meta property="og:site_name" content="The Podcast at Delphi.org" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-01-26T09:56:23-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Decompressing the TRESTResponse" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jim McKeeth"},"dateModified":"2016-01-26T09:56:23-07:00","datePublished":"2016-01-26T09:56:23-07:00","description":"RAD Studio, Delphi and C++ 10 Seattle has a fantastic REST Client Library. If you are unfamiliar with it, check out my 5 Minute REST Client video.","headline":"Decompressing the TRESTResponse","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2016/01/decompressing-the-trestresponse/"},"url":"http://localhost:4000/2016/01/decompressing-the-trestresponse/"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>delphiorg.github.io</h1>
        </a>
        <h2>The Podcast about the Delphi programming language, tools, news and community.</h2>

        <section id="downloads">
          
          <a href="https://github.com/delphiorg/delphiorg.github.io" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <small>26 January 2016</small>
<h1>Decompressing the TRESTResponse</h1>

<p class="view">by Jim McKeeth</p>

<p>RAD Studio, Delphi and C++ 10 Seattle has a fantastic <a href="http://docwiki.embarcadero.com/RADStudio/en/REST_Client_Library">REST Client Library</a>. If you are unfamiliar with it, check out my <a href="http://delphi.org/2015/10/rest-client-video-challenge/">5 Minute REST Client video</a>.</p>

<p>The <strong><a href="http://docwiki.embarcadero.com/Libraries/en/REST.Client.TRESTRequest">TRESTRequest</a></strong> component has an <em>AcceptEncoding</em> property where you can specify the type of compression you would like applied to the response. The <strong><a href="http://docwiki.embarcadero.com/Libraries/en/REST.Client.TRESTResponse">TRESTResponse</a></strong> component has a <em>ContentEncoding</em> property that specifies the the encoding that the server chose. The most common compression encoding is <strong>gzip</strong>, followed by <strong>deflate</strong>. The others are rarely used (although <a href="http://google-opensource.blogspot.com/2015/09/introducing-brotli-new-compression.html">brotli</a> is a new compression that looks promising for the future.)</p>

<p>By default it is not encrypted if you leave AcceptEncoding blank. However when you use the <a href="https://api.stackexchange.com/docs">Stack Overflow API</a> it <a href="https://api.stackexchange.com/docs/compression">always compresses</a> with gzip if nothing is specified.</p>

<p>The TRESTResponse has two ways to access the response data directly, the RawBytes property and the Content property. Both are read-only. So we can read the compressed response data, but cannot update the TRESTResponse with the decompressed data. Updating the TRESTReponse allows it to work with the <a href="http://docwiki.embarcadero.com/Libraries/Seattle/en/REST.Response.Adapter.TRESTResponseDataSetAdapter">TRESTResponseDataSetAdapter</a>, which is a fantastic feature.</p>

<p>Luckily we can use the protected mode workaround to update the value. Here is a unit that you can include in your project to easily decompress the TRESTResponse and continue to use it with the Data Set Adapter.</p>

<p>[delphi]
unit RestDecompress;</p>

<p>interface</p>

<p>uses
  System.SysUtils, System.Types, System.Classes, IPPeerClient, REST.Client;</p>

<p>procedure DecodeRestResponse(ARestResponse: TRESTResponse);</p>

<p>implementation</p>

<p>uses
  System.Zlib,
  IdBaseComponent, IdException, IdZLibCompressorBase, IdCompressorZLib;</p>

<p>type // protected mode work around
  TProtectedRESTResponse = class(TRESTResponse)
  end;</p>

<p>procedure DecodeRestResponse(ARestResponse: TRESTResponse);
var
  LCompressed: TMemoryStream;
  LDecompressed: TStringStream;
  LDecompress: TIdCompressorZLib;
begin
  if Length(ARestResponse.ContentEncoding) = 0 then exit;</p>

<p>LCompressed := nil;
  LDecompressed := nil;
  LDecompress := nil;
  try
    LCompressed := TMemoryStream.Create;
    LDecompressed := TStringStream.Create;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LCompressed.WriteData(ARESTResponse.RawBytes, Length(ARESTResponse.RawBytes));
LCompressed.Position := 0;

// Use the Indy decompression libraries because the HTTP stream doesn't
//   have the proper headers that System.ZLib looks for.

LDecompress :=TIdCompressorZLib.Create();

if ARestResponse.ContentEncoding = 'gzip' then
  LDecompress.DecompressGZipStream(LCompressed, LDecompressed)
else if ARestResponse.ContentEncoding = 'deflate' then
begin
  // Due to variations in the deflate server side implementations,
  //   this rarely works, but is here for completeness and just in case
  LDecompress.DecompressHTTPDeflate(LCompressed, LDecompressed);
end;

TProtectedRESTResponse(ARESTResponse).SetContent(LDecompressed.DataString);   finally
LDecompressed.Free;
LCompressed.Free;
LDecompress.Free;   end; end;
</code></pre></div></div>

<p>end.
[/delphi]</p>

<p>Simply use this unit, and then add a call to DecodeRestResponse(RESTResponse) to RESTResponse’s OnAfterExecute event handler. It checks the ContentEncoding and then uses the correct decompression and updates the content.</p>

<p>You’ll notice it uses the Indy <strong>TIdCompressorZLib</strong> component instead of the new System.ZLib library. The reason is a GZip encoded HTTP response doesn’t include the full headers expected by the ZLib library. There is a way to work around this, but no need to do that since the Indy library works fine.</p>



  <small>tags: <em>compression</em> - <em>GZIP</em> - <em>JSON</em> - <em>News</em> - <em>REST</em> - <em>TIdCompressorZLib</em> - <em>TRESTClient</em> - <em>TRESTResponse</em></small>


      </section>
    </div>
  </body>
</html>
