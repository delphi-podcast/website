<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=8dce9d32f790087ba98d18ab087bc3f67f3d9fc2">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Run Outside the Handler or Making a Non-Blocking Call | The Podcast at Delphi.org</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Run Outside the Handler or Making a Non-Blocking Call" />
<meta name="author" content="Jim McKeeth" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Have you ever had some code you wanted to run outside of the event handler that causes the code to run? If not, then this blog post isn’t for you. I’m not here to debate why you would want to do that, or if it is a good idea or not. I just know there’ve been times I’ve needed my code to run outside the event handler, or just a bit later." />
<meta property="og:description" content="Have you ever had some code you wanted to run outside of the event handler that causes the code to run? If not, then this blog post isn’t for you. I’m not here to debate why you would want to do that, or if it is a good idea or not. I just know there’ve been times I’ve needed my code to run outside the event handler, or just a bit later." />
<link rel="canonical" href="http://localhost:4000/2015/01/run-outside-handler-making-a-non-blocking-call/" />
<meta property="og:url" content="http://localhost:4000/2015/01/run-outside-handler-making-a-non-blocking-call/" />
<meta property="og:site_name" content="The Podcast at Delphi.org" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-01-20T16:31:09-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Run Outside the Handler or Making a Non-Blocking Call" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jim McKeeth"},"dateModified":"2015-01-20T16:31:09-07:00","datePublished":"2015-01-20T16:31:09-07:00","description":"Have you ever had some code you wanted to run outside of the event handler that causes the code to run? If not, then this blog post isn’t for you. I’m not here to debate why you would want to do that, or if it is a good idea or not. I just know there’ve been times I’ve needed my code to run outside the event handler, or just a bit later.","headline":"Run Outside the Handler or Making a Non-Blocking Call","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2015/01/run-outside-handler-making-a-non-blocking-call/"},"url":"http://localhost:4000/2015/01/run-outside-handler-making-a-non-blocking-call/"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>delphiorg.github.io</h1>
        </a>
        <h2>The Podcast about the Delphi programming language, tools, news and community.</h2>

        <section id="downloads">
          
          <a href="https://github.com/delphiorg/delphiorg.github.io" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <small>20 January 2015</small>
<h1>Run Outside the Handler or Making a Non-Blocking Call</h1>

<p class="view">by Jim McKeeth</p>

<p>Have you ever had some code you wanted to run outside of the event handler that causes the code to run? If not, then this blog post isn’t for you. I’m not here to debate why you would want to do that, or if it is a good idea or not. I just know there’ve been times I’ve needed my code to run outside the event handler, or just a bit later.</p>

<p>One use case example: You are calling a slow routine (Network I/O maybe) and don’t want to freeze the UI while you wait for it to execute.</p>

<p>Still with me? Good. What I used to do was drop a TTimer on the form and set the Interval to 1, then enable it to trigger the code to run later. This worked, but it was messy. You had a timer to deal with, and you had to remember to disable it in the event handler, so it didn’t run multiple times. You also could have used a TThread, which may have been a better solution, but still seemed kind of messy, especially if you wanted to update the UI from your code.</p>

<p>Thanks to the new System.Threading library introduced with XE7, I’ve created a simple procedure that makes this a breeze to do. I call the procedure <strong>NonBlocking</strong>, but you could just as easily call it <em>RunALittleLater</em>, <em>RunOutsideHandler</em>, etc.</p>

<p>[delphi]
uses System.Threading;</p>

<p>procedure NonBlocking(const Proc: TThreadProcedure);
begin
  TTask.Create(procedure begin
    TThread.Queue(nil, Proc);
  end).Start;
end;
[/delphi]</p>

<p>All this does is create a task, and then inside the task queue an update back to the main thread to execute the code that is passed to this procedure as an anonymous method. You could easily just write this code inline, but I thought it worthwhile creating a procedure to handle it for me.</p>

<p>Lets look at a normal execution scenario:</p>

<p>[delphi]
  //…
  ListBox1.Items.Add(‘Before Handler’);
  EventHandler;
  ListBox1.Items.Add(‘After Handler’);
  //….</p>

<p>procedure TForm1.EventHandler;
begin
  ListBox1.Items.Add(‘Inside Handler’);
end;
[/delphi]</p>

<p>When this is run, our ListBox1 will look like</p>
<ul>
	<li>Before Handler</li>
	<li>Inside Handler</li>
	<li>After Handler</li>
</ul>
<p>which is what we would expect. Now when we introduce a call to our new procedure in the EventHandler:</p>

<p>[delphi]
  //…
  ListBox1.Items.Add(‘Before Handler’);
  EventHandler;
  ListBox1.Items.Add(‘After Handler’);
  //….</p>

<p>procedure TForm1.EventHandler;
begin
  ListBox1.Items.Add(‘Inside Handler 1’);
  NonBlocking(procedure begin
    ListBox1.Items.Add(‘Outside Handler’); // This will run last
  end);
  ListBox1.Items.Add(‘Inside Handler 2’);
end;
[/delphi]</p>

<p>Our ListBox1 will look like</p>
<ul>
	<li>Before Handler</li>
	<li>Inside Handler 1</li>
	<li>Inside Handler 2</li>
	<li>After Handler</li>
	<li><strong>Outside Handler</strong></li>
</ul>
<p>Notice that Outside Handler was the very last line added, even though it is written between Inside Handler 1 and Inside Handler 2. It even occurs after the <em>After Handler</em> line. Also, this works across all platforms: iOS, Android, Windows and OS X.</p>

<p>Everything before and within the call to <em>NonBlocking</em> will execute in order, but the code within NonBlocking will execute after the code that comes after that anonymous method.</p>

<p>If you have a ShowMessage or something else that blocks the UI thread in the event handler, then the code you passed to the <em>NonBlocking</em> procedure will be executed early, which is fine since the UI thread was already blocked.</p>

<p> </p>



  <small>tags: <em>Source Code</em></small>


      </section>
    </div>
  </body>
</html>
